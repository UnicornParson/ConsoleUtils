#!/usr/bin/env python3
import os
import sys
import argparse
import git

def read_file_content(filepath):
    """Read file content with error handling for different encodings"""
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            return f.read()
    except UnicodeDecodeError:
        try:
            with open(filepath, 'r', encoding='latin-1') as f:
                return f.read()
        except Exception as e:
            return f"[File reading error: {e}]"
    except Exception as e:
        return f"[File reading error: {e}]"

def find_files_git(directory, extensions, repo):
    """Find files using git ls-files"""
    matching_files = []
    
    repo_root = repo.working_tree_dir
    
    # Получаем относительный путь от корня репозитория до заданной директории
    try:
        rel_dir = os.path.relpath(directory, repo_root)
    except ValueError:
        # Если directory не является поддиректорией repo_root (маловероятно)
        rel_dir = '.'
    
    # Получаем список файлов в репозитории, которые не игнорируются
    try:
        files = repo.git.ls_files('--full-name', '--cached', '--others', '--exclude-standard').splitlines()
    except Exception as e:
        print(f"Warning: git ls-files failed: {e}", file=sys.stderr)
        return []
    
    # Нормализуем расширения
    normalized_extensions = {ext.lower().lstrip('.') for ext in extensions}
    
    for file in files:
        # file - путь относительно корня репозитория
        # Проверяем, находится ли файл внутри rel_dir
        if rel_dir != '.':
            # Если заданная директория не корень, то файл должен начинаться с rel_dir
            # Используем os.path.join для кроссплатформенности
            rel_file = file.replace('/', os.sep)
            if not rel_file.startswith(rel_dir + os.sep):
                continue
        
        # Полный путь к файлу
        full_path = os.path.join(repo_root, file)
        
        # Проверяем расширение
        _, ext = os.path.splitext(file)
        ext = ext.lower().lstrip('.')
        if ext in normalized_extensions:
            matching_files.append(full_path)
    
    return sorted(matching_files)

def find_files_nogit(directory, extensions):
    """Find files using os.walk (without .gitignore)"""
    matching_files = []
    
    normalized_extensions = {ext.lower().lstrip('.') for ext in extensions}
    
    for root, dirs, files in os.walk(directory):
        # Исключаем директорию .git
        if '.git' in dirs:
            dirs.remove('.git')
        
        for file in files:
            _, ext = os.path.splitext(file)
            ext = ext.lower().lstrip('.')
            if ext in normalized_extensions:
                full_path = os.path.join(root, file)
                matching_files.append(full_path)
    
    return sorted(matching_files)

def find_files(directory, extensions):
    """Find files with specified extensions, respecting .gitignore if in a git repo"""
    # Пытаемся использовать GitPython для обнаружения репозитория
    try:

        try:
            repo = git.Repo(directory, search_parent_directories=True)
            # Репозиторий найден, используем git-метод
            print(f"Using git repository at: {repo.working_tree_dir}", file=sys.stderr)
            return find_files_git(directory, extensions, repo)
        except git.InvalidGitRepositoryError:
            # Не Git-репозиторий, используем обычный метод
            print("Not a git repository, ignoring .gitignore", file=sys.stderr)
            return find_files_nogit(directory, extensions)
    except ImportError:
        # GitPython не установлен, используем обычный метод
        print("GitPython not installed, ignoring .gitignore", file=sys.stderr)
        return find_files_nogit(directory, extensions)

def main():
    parser = argparse.ArgumentParser(
        description='Merge contents of files with specified extensions'
    )
    parser.add_argument('directory', help='Path to directory for file search')
    parser.add_argument('extensions', nargs='+', help='File extensions (e.g., py txt cpp)')

    args = parser.parse_args()

    # Check if directory exists
    if not os.path.isdir(args.directory):
        print(f"Error: Directory '{args.directory}' does not exist", file=sys.stderr)
        sys.exit(1)

    # Find files
    files = find_files(args.directory, args.extensions)

    if not files:
        print(f"No files with extensions {args.extensions} found in '{args.directory}'", file=sys.stderr)
        sys.exit(0)

    # Output content of each file
    for filepath in files:
        # Output separator with file path
        print(f"\n{'=' * 7}  {filepath}  {'=' * 7}\n")

        # Read and output file content
        content = read_file_content(filepath)
        print(content)

    # Final separator with count
    print(f"\n{'=' * 7}  Total files: {len(files)}  {'=' * 7}")

if __name__ == "__main__":
    main()